<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FpsZz - Vers√£o Est√°vel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            overflow: hidden; 
            font-family: 'Arial', sans-serif;
        }
        
        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #00ff00;
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 5px;
            border: 2px solid #00ff00;
            font-weight: bold;
        }
        
        #health {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #ff5555;
            font-size: 24px;
            font-weight: bold;
            background: rgba(0,0,0,0.8);
            padding: 8px 25px;
            border-radius: 20px;
            border: 2px solid #ff0000;
        }
        
        #ammo {
            position: absolute;
            bottom: 30px;
            right: 30px;
            color: #ffff00;
            font-size: 32px;
            font-weight: bold;
            background: rgba(0,0,0,0.8);
            padding: 10px 25px;
            border-radius: 10px;
            border: 2px solid #ffaa00;
            text-align: center;
        }
        
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 36px;
            font-weight: bold;
            text-shadow: 0 0 10px red;
            z-index: 1000;
        }
        
        #score {
            position: absolute;
            bottom: 30px;
            left: 30px;
            color: #00ffff;
            font-size: 24px;
            font-weight: bold;
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #00ffff;
        }
        
        #weapon {
            position: absolute;
            bottom: 100px;
            right: 30px;
            color: white;
            font-size: 16px;
            background: rgba(0,0,0,0.7);
            padding: 5px 15px;
            border-radius: 5px;
            border: 1px solid #ffaa00;
        }
        
        #debug {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: yellow;
            font-size: 12px;
            background: rgba(0,0,0,0.5);
            padding: 3px 8px;
            border-radius: 3px;
            z-index: 2000;
        }
        
        #controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: #aaa;
            font-size: 12px;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <div id="hud">
        <div id="info">FPSZZ - VERS√ÉO EST√ÅVEL</div>
        <div id="health">‚ù§Ô∏è 100</div>
        <div id="ammo">30/30</div>
        <div id="crosshair">+</div>
        <div id="score">üèÜ 0</div>
        <div id="weapon">AK-47</div>
        <div id="debug">Status: OK</div>
        <div id="controls">WASD = andar | Mouse = mirar | Clique = atirar | R = recarregar</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // ==================== CONFIGURA√á√ÉO INICIAL ====================
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // C√©u azul claro
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 5);
        camera.rotation.order = 'YXZ'; // Importante para FPS
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);
        
        // ==================== ILUMINA√á√ÉO ====================
        const ambientLight = new THREE.AmbientLight(0x404060);
        scene.add(ambientLight);
        
        const sunLight = new THREE.DirectionalLight(0xffeedd, 1);
        sunLight.position.set(5, 10, 7);
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.width = 1024;
        sunLight.shadow.mapSize.height = 1024;
        scene.add(sunLight);
        
        // ==================== CEN√ÅRIO ====================
        // Ch√£o
        const groundGeometry = new THREE.PlaneGeometry(30, 30);
        const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x335533 });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = 0;
        ground.receiveShadow = true;
        scene.add(ground);
        
        // Grade
        const gridHelper = new THREE.GridHelper(30, 20, 0xffaa00, 0x444444);
        gridHelper.position.y = 0.01;
        scene.add(gridHelper);
        
        // Paredes/obst√°culos
        function createWall(x, z, width, height, depth, color) {
            const geometry = new THREE.BoxGeometry(width, height, depth);
            const material = new THREE.MeshStandardMaterial({ color: color });
            const wall = new THREE.Mesh(geometry, material);
            wall.position.set(x, height/2, z);
            wall.castShadow = true;
            wall.receiveShadow = true;
            return wall;
        }
        
        scene.add(createWall(-5, -5, 1, 3, 8, 0x777777));
        scene.add(createWall(5, -5, 1, 3, 8, 0x777777));
        scene.add(createWall(-5, 5, 8, 3, 1, 0x777777));
        scene.add(createWall(5, 5, 8, 3, 1, 0x777777));
        scene.add(createWall(0, 0, 2, 2, 2, 0xaa5555));
        
        // Caixas espalhadas
        for (let i = 0; i < 5; i++) {
            const boxGeo = new THREE.BoxGeometry(1, 0.5, 1);
            const boxMat = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            const box = new THREE.Mesh(boxGeo, boxMat);
            box.position.set(Math.random() * 8 - 4, 0.25, Math.random() * 8 - 4);
            box.castShadow = true;
            box.receiveShadow = true;
            scene.add(box);
        }
        
        // ==================== SISTEMA DE INIMIGOS ====================
        class Enemy {
            constructor(x, z) {
                this.group = new THREE.Group();
                this.health = 100;
                this.id = Math.random();
                
                // Corpo
                const bodyGeo = new THREE.BoxGeometry(0.8, 1.5, 0.8);
                const bodyMat = new THREE.MeshStandardMaterial({ color: 0xff4444 });
                const body = new THREE.Mesh(bodyGeo, bodyMat);
                body.position.y = 0.75;
                body.castShadow = true;
                body.receiveShadow = true;
                this.group.add(body);
                
                // Cabe√ßa
                const headGeo = new THREE.SphereGeometry(0.4, 8, 8);
                const headMat = new THREE.MeshStandardMaterial({ color: 0xffaa88 });
                const head = new THREE.Mesh(headGeo, headMat);
                head.position.y = 1.6;
                head.castShadow = true;
                head.receiveShadow = true;
                this.group.add(head);
                
                // Barra de vida (fundo preto)
                const barBgGeo = new THREE.BoxGeometry(1.1, 0.15, 0.1);
                const barBgMat = new THREE.MeshStandardMaterial({ color: 0x000000 });
                this.healthBarBg = new THREE.Mesh(barBgGeo, barBgMat);
                this.healthBarBg.position.y = 2.2;
                this.group.add(this.healthBarBg);
                
                // Barra de vida (verde)
                const barGeo = new THREE.BoxGeometry(1, 0.1, 0.1);
                const barMat = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
                this.healthBar = new THREE.Mesh(barGeo, barMat);
                this.healthBar.position.y = 2.2;
                this.group.add(this.healthBar);
                
                this.group.position.set(x, 0, z);
            }
            
            updateHealthBar() {
                if (this.healthBar) {
                    const scale = Math.max(0, this.health / 100);
                    this.healthBar.scale.x = scale;
                    this.healthBar.position.x = (1 - scale) * 0.5;
                    
                    // Muda cor conforme vida
                    if (this.health < 30) {
                        this.healthBar.material.color.setHex(0xff0000);
                    } else if (this.health < 60) {
                        this.healthBar.material.color.setHex(0xffff00);
                    }
                }
            }
            
            takeDamage(damage) {
                this.health -= damage;
                this.updateHealthBar();
                
                // Feedback visual
                this.group.children[0].material.emissive.setHex(0x442200);
                setTimeout(() => {
                    if (this.group.children[0]) {
                        this.group.children[0].material.emissive.setHex(0x000000);
                    }
                }, 100);
                
                return this.health <= 0;
            }
        }
        
        // Lista de inimigos (array principal)
        const enemies = [];
        
        // Criar inimigos iniciais
        function spawnEnemy(x, z) {
            const enemy = new Enemy(x, z);
            enemies.push(enemy);
            scene.add(enemy.group);
            return enemy;
        }
        
        // Spawnar 4 inimigos
        spawnEnemy(-3, -3);
        spawnEnemy(3, -3);
        spawnEnemy(-3, 3);
        spawnEnemy(3, 3);
        
        // ==================== SISTEMA DE PROJ√âTEIS ====================
        const bullets = [];
        
        function createBullet(position, direction, isEnemy = false) {
            const geometry = new THREE.SphereGeometry(0.1, 4, 4);
            const material = new THREE.MeshStandardMaterial({ 
                color: isEnemy ? 0xffaa00 : 0xffff00,
                emissive: isEnemy ? 0x442200 : 0x222200
            });
            const bullet = new THREE.Mesh(geometry, material);
            bullet.position.copy(position);
            
            bullet.userData = {
                velocity: direction.clone().multiplyScalar(isEnemy ? 0.15 : 0.3),
                damage: isEnemy ? 10 : 34,
                isEnemy: isEnemy,
                life: 100
            };
            
            bullets.push(bullet);
            scene.add(bullet);
        }
        
        // ==================== JOGADOR ====================
        let health = 100;
        let score = 0;
        let ammo = 30;
        let reserveAmmo = 90;
        let canShoot = true;
        let isReloading = false;
        
        const moveSpeed = 0.15;
        const keys = {};
        
        // Atualizar HUD
        function updateHUD() {
            document.getElementById('health').innerHTML = `‚ù§Ô∏è ${Math.max(0, health)}`;
            document.getElementById('score').innerHTML = `üèÜ ${score}`;
            document.getElementById('ammo').innerHTML = `${ammo}/30<br><span style="font-size:14px;">reserva: ${reserveAmmo}</span>`;
        }
        
        // ==================== CONTROLES ====================
        document.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            
            // Recarregar
            if (e.code === 'KeyR' && !isReloading && ammo < 30 && reserveAmmo > 0) {
                isReloading = true;
                document.getElementById('weapon').innerHTML = 'RECARREGANDO...';
                
                setTimeout(() => {
                    const needed = 30 - ammo;
                    const available = Math.min(needed, reserveAmmo);
                    ammo += available;
                    reserveAmmo -= available;
                    isReloading = false;
                    document.getElementById('weapon').innerHTML = 'AK-47';
                    updateHUD();
                }, 2000);
            }
        });
        
        document.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });
        
        // Mouse lock e tiro
        document.addEventListener('click', () => {
            if (document.pointerLockElement !== document.body) {
                document.body.requestPointerLock();
            } else if (canShoot && !isReloading && ammo > 0) {
                // Atirar
                ammo--;
                canShoot = false;
                updateHUD();
                
                // Pequeno recuo visual
                camera.rotation.x -= 0.01;
                
                // Raycast para tiro
                const raycaster = new THREE.Raycaster();
                const direction = new THREE.Vector3(0, 0, -1);
                direction.applyQuaternion(camera.quaternion);
                raycaster.set(camera.position, direction);
                
                // Verificar colis√£o com inimigos
                const enemyGroups = enemies.map(e => e.group);
                const intersects = raycaster.intersectObjects(enemyGroups, true);
                
                if (intersects.length > 0) {
                    // Encontrar qual inimigo foi atingido
                    const hitGroup = intersects[0].object.parent;
                    const hitEnemy = enemies.find(e => e.group === hitGroup);
                    
                    if (hitEnemy && hitEnemy.health > 0) {
                        const died = hitEnemy.takeDamage(34); // Dano da AK
                        
                        if (died) {
                            // Remover inimigo da cena e da lista
                            scene.remove(hitEnemy.group);
                            const index = enemies.indexOf(hitEnemy);
                            if (index > -1) enemies.splice(index, 1);
                            
                            // Aumentar pontua√ß√£o
                            score += 100;
                            reserveAmmo += 15;
                            updateHUD();
                            
                            // Spawnar novo inimigo se tiver menos que 4
                            if (enemies.length < 4) {
                                setTimeout(() => {
                                    const angle = Math.random() * Math.PI * 2;
                                    const radius = 4;
                                    const x = Math.cos(angle) * radius;
                                    const z = Math.sin(angle) * radius;
                                    spawnEnemy(x, z);
                                }, 3000);
                            }
                        }
                    }
                }
                
                // Cooldown do tiro
                setTimeout(() => {
                    canShoot = true;
                }, 120); // Aproximadamente 500 RPM
            }
        });
        
        // Movimento do mouse (olhar)
        document.addEventListener('mousemove', (e) => {
            if (document.pointerLockElement === document.body) {
                camera.rotation.y -= e.movementX * 0.002;
                camera.rotation.x -= e.movementY * 0.002;
                camera.rotation.x = Math.max(-Math.PI/3, Math.min(Math.PI/3, camera.rotation.x));
            }
        });
        
        // ==================== LOOP PRINCIPAL ====================
        let lastEnemyShoot = 0;
        
        function animate() {
            requestAnimationFrame(animate);
            
            // Movimenta√ß√£o WASD
            if (keys['KeyW']) {
                camera.position.x -= Math.sin(camera.rotation.y) * moveSpeed;
                camera.position.z -= Math.cos(camera.rotation.y) * moveSpeed;
            }
            if (keys['KeyS']) {
                camera.position.x += Math.sin(camera.rotation.y) * moveSpeed;
                camera.position.z += Math.cos(camera.rotation.y) * moveSpeed;
            }
            if (keys['KeyA']) {
                camera.position.x -= Math.cos(camera.rotation.y) * moveSpeed;
                camera.position.z += Math.sin(camera.rotation.y) * moveSpeed;
            }
            if (keys['KeyD']) {
                camera.position.x += Math.cos(camera.rotation.y) * moveSpeed;
                camera.position.z -= Math.sin(camera.rotation.y) * moveSpeed;
            }
            
            // Limites do mapa
            camera.position.x = Math.max(-7, Math.min(7, camera.position.x));
            camera.position.z = Math.max(-7, Math.min(7, camera.position.z));
            
            // Atualizar debug info
            document.getElementById('debug').innerHTML = `Inimigos: ${enemies.length} | Pos: ${camera.position.x.toFixed(1)}, ${camera.position.z.toFixed(1)}`;
            
            // Inimigos atiram
            const now = Date.now();
            if (now - lastEnemyShoot > 800 && enemies.length > 0) {
                enemies.forEach(enemy => {
                    if (enemy.health > 0 && Math.random() < 0.4) {
                        // Dire√ß√£o do tiro (com erro)
                        const dir = new THREE.Vector3().subVectors(camera.position, enemy.group.position).normalize();
                        dir.x += (Math.random() - 0.5) * 0.2;
                        dir.z += (Math.random() - 0.5) * 0.2;
                        dir.normalize();
                        
                        // Criar bala
                        const bulletPos = enemy.group.position.clone();
                        bulletPos.y += 1;
                        createBullet(bulletPos, dir, true);
                    }
                });
                lastEnemyShoot = now;
            }
            
            // Atualizar balas
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.position.add(bullet.userData.velocity);
                bullet.userData.life--;
                
                // Colis√£o com jogador (balas inimigas)
                if (bullet.userData.isEnemy) {
                    const dist = bullet.position.distanceTo(camera.position);
                    if (dist < 1.0) {
                        health -= bullet.userData.damage;
                        updateHUD();
                        scene.remove(bullet);
                        bullets.splice(i, 1);
                        
                        if (health <= 0) {
                            alert(`Game Over! Pontua√ß√£o: ${score}`);
                            health = 100;
                            score = 0;
                            ammo = 30;
                            reserveAmmo = 90;
                            updateHUD();
                            
                            // Recriar inimigos
                            enemies.forEach(e => scene.remove(e.group));
                            enemies.length = 0;
                            spawnEnemy(-3, -3);
                            spawnEnemy(3, -3);
                            spawnEnemy(-3, 3);
                            spawnEnemy(3, 3);
                        }
                        continue;
                    }
                }
                
                // Remover balas velhas ou distantes
                if (bullet.userData.life <= 0 || 
                    Math.abs(bullet.position.x) > 20 || 
                    Math.abs(bullet.position.z) > 20) {
                    scene.remove(bullet);
                    bullets.splice(i, 1);
                }
            }
            
            // Animar inimigos
            enemies.forEach((enemy, index) => {
                if (enemy.health > 0) {
                    // Movimento de "flutua√ß√£o"
                    enemy.group.position.y = Math.sin(now * 0.003 + index) * 0.1;
                    
                    // Olhar pro jogador
                    enemy.group.lookAt(camera.position);
                }
            });
            
            renderer.render(scene, camera);
        }
        
        animate();
        
        // ==================== RESIZE ====================
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Iniciar HUD
        updateHUD();
    </script>
</body>
</html>
